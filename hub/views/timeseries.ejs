<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grain Dryer</title>
    <link rel="stylesheet" href="jquery-ui.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
    <script src="jquery-3.1.0.min.js"></script>

    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="jquery-ui.min.js"></script>
    <!-- d3-tooltip script -->
    <!--*****************************************************************************-->
<!-- 	<script src="timeline.js"></script> -->
    <script src="brush.js"></script>
    <script>
    $( function() {
    $( "#datepicker" ).datepicker();
  } );
    </script>
</head>
<body>
    <div class="header">
        <span class="material-icons " id="collopse-button">menu</span>
        <div id="header-title">Grain Dryer</div>
    </div>
    <div class="form-container">
        <div class="form">
            <h3>Display Range</h3>
            <div class="form-content">
                <div id="range">
                    <form>
                        <label>Temperature Range</label>
                        <input type="number" name="TMin" required>
                        ~<input type="number" name="TMax" required>
                        <div></div>
                        <label>Humidity Range</label>
                        <input type="number" name="HMin" required>
                        ~<input type="number" name="HMax" required>
                        <div class="warning" id="rangeerror">This field should be a number</div>
                    </form>
                </div>
                <div class="clearfix"></div>

            </div>
            <div class="submit-button" id="submit-button4"><span>Submit</span></div>
            <div class="cancel-button" id="cancel-button"><span>Cancel</span></div>
        </div>
        <div class="close"></div>
    </div>
    <div class="clearfix"></div>
    <div class="container">
        <!--
        main bar chart for current data
        -->
        <div class="sidebar">

            <div class="sidebar-column" id="add-range">
                <span class="material-icons">add_box</span>
                <div style="display:inline-block;overflow: hidden;text-overflow:ellipsis;">Add Display Range</div>
            </div>
        </div>
<!-- ************************************************************ -->

        <div class="main-visual">
            <div class="selections">
                <div class="selects" id="select-right">RIGHT</div>
                <div class="selects" id="select-middle">MIDDLE</div>
                <div class="selects" id="select-left">LEFT</div>
                <div class="selects" id="select-fan">FAN</div>
                <div class="selects" id="select-dryer">DRYER</div>
            </div>
        <!-- ************************************************************ -->
        <!-- 	<div class="clearfix"></div> -->
            <div class="slider" id="time-bar"></div>
            <div class="dropdown">
                <button class="dropbtn">FAN Side</button>
                <div class="dropdown-content">
                    <div id="disF_left">LEFT</div>
                    <div id="disF_middle">MIDDLE</div>
                    <div id="disF_right">RIGHT</div>
                  </div>
            </div>
            <div class="dropdown">
                <button class="dropbtn">Dryer Side</button>
                <div class="dropdown-content">
                    <div id="disD_left">LEFT</div>
                    <div id="disD_middle">MIDDLE</div>
                    <div id="disD_right">RIGHT</div>
                  </div>
            </div>
            <div class="clearfix"></div>
            
            <div class="draw">
                <div id="chart22" class="charts charts-hidden">
                    <div class="chart-header">FAN Right Top</div>
                    <div id="chart22-svg" class="chart-svg"></div>
                </div>  
            <!-- ************************************************************ -->
                <div id="chart23" class="charts charts-hidden">
                    <div class="chart-header">FAN Middle Top</div>
                    <div id="chart23-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart24" class="charts charts-hidden">
                    <div class="chart-header">FAN Left Top</div>
                    <div id="chart24-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart19" class="charts charts-hidden">
                    <div class="chart-header">FAN right 2nd</div>
                    <div id="chart19-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart21" class="charts charts-hidden">
                    <div class="chart-header">FAN Left 2nd</div>
                    <div id="chart21-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ --> 
                <div id="chart20" class="charts charts-hidden">
                    <div class="chart-header">FAN Middle 2nd</div>
                    <div id="chart20-svg" class="chart-svg"></div>
                </div>   
            <!-- ************************************************************ -->
                <div id="chart16" class="charts charts-hidden">
                    <div class="chart-header">FAN Right 3rd</div>
                    <div id="chart16-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart17" class="charts charts-hidden">
                    <div class="chart-header">FAN Middle 3rd</div>
                    <div id="chart17-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart18" class="charts charts-hidden">
                    <div class="chart-header">FAN Left 3rd</div>
                    <div id="chart18-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ --> 
                <div id="chart13" class="charts charts-hidden">
                    <div class="chart-header">FAN Right Bottom</div>
                    <div id="chart13-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart14" class="charts charts-hidden">
                    <div class="chart-header">FAN Middle Bottom</div>
                    <div id="chart14-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart15" class="charts charts-hidden">
                    <div class="chart-header">FAN Left Bottom</div>
                    <div id="chart15-svg" class="chart-svg"></div>
                </div>
            </div>
            <!-- ************************************************************ -->
        
            
        <!-- ************************************************************ -->
            <div class="draw">
                <div id="chart10" class="charts charts-hidden">
                    <div class="chart-header">Dryer Right Top</div>
                    <div id="chart10-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->    
                <div id="chart12" class="charts charts-hidden">
                    <div class="chart-header">Dryer Left Top</div>
                    <div id="chart12-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart11" class="charts charts-hidden">
                    <div class="chart-header">Dryer Middle Top</div>
                    <div id="chart11-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart7" class="charts charts-hidden">
                    <div class="chart-header">Dryer right 2nd</div>
                    <div id="chart7-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart8" class="charts charts-hidden">
                    <div class="chart-header">Dryer Middle 2nd</div>
                    <div id="chart8-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart9" class="charts charts-hidden">
                    <div class="chart-header">Dryer Left 2nd</div>
                    <div id="chart9-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
                <div id="chart4" class="charts charts-hidden">
                    <div class="chart-header">Dryer Right 3rd</div>
                    <div id="chart4-svg" class="chart-svg"></div>
                </div>
                <!-- <div class="clearfix"></div> -->
            <!-- ************************************************************ -->
                <div id="chart5" class="charts charts-hidden">
                    <div class="chart-header">Dryer Middle 3rd</div>
                    <div id="chart5-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
            
            <!-- ************************************************************ -->
                <div id="chart6" class="charts charts-hidden">
                    <div class="chart-header">Dryer Left 3rd</div>
                    <div id="chart6-svg" class="chart-svg"></div>
                </div>
             <!-- ************************************************************ -->
             <!-- ************************************************************ -->
                <div id="chart1" class="charts charts-hidden">
                    <div class="chart-header">Dryer Right Bottom</div>
                    <div id="chart1-svg" class="chart-svg"></div>
                </div>
            

                <div id="chart2" class="charts charts-hidden">
                    <div class="chart-header">Dryer Middle Bottom</div>
                    <div id="chart2-svg" class="chart-svg"></div>
                </div>
            <!-- ************************************************************ -->
            <!-- ************************************************************ -->
                <div id="chart3" class="charts charts-hidden">
                    <div class="chart-header">Dryer Left Bottom</div>
                    <div id="chart3-svg" class="chart-svg"></div>
                </div>
            </div>
        <!-- ************************************************************ -->
            <div class="clearfix"></div>
            <div style="height:50px;width:100%"></div>
        </div>
<!-- ************************************************************ -->
    </div>
    <div class="clearfix"></div>

</body>

<script>
    var gALL,
        gFAN,
        gDRYER,
        gRIGHT,
        gMIDDLE,
        gLEFT,
        gFANRIGHT,
        gFANMIDDLE,
        gFANLEFT= [];
    gALL = [1,4,7,10,12,15,18,21];
    gDRYER = [0,1,2,3,4,5,6,7,8,9,10,11];
    gFAN = [12,13,14,15,16,17,18,19,20,21,22,23];
    gRIGHT = [0,3,6,9,12,15,18,21];
    gMIDDLE = [1,4,7,10,13,16,19,22];
    gLEFT = [2,5,8,11,14,17,20,23];
    gFANLEFT = [14,17,20,23];
    gFANRIGHT = [12,15,18,21];
    gFANMIDDLE = [13,16,19,22];

    var gchoiceD = gDRYER;
    var gchoiceF = gFAN;
    var gdisplay_array = null;
    var gdisplay_side = null;
    var gdisplay_par;
    var gRanges = null;
    var gdisplay_class = $('#all-view');

</script>
<script>
    /***********************************************************************************/
    var gTempData = <%-TempDatum%>
    var gEMCData = <%-EMCDatum%>



    var arrayIntersect = function(a, b)
    {
        return $.grep(a, function(i)
        {
            return $.inArray(i, b) > -1;
        });
    };

    $(document).ready(function(){
        draw(gALL,null,null,false);
    });
    $( window ).resize(function() {
        var width = $(window).width();
        d3.selectAll('svg').remove();
        var whole = gdisplay_par>0.9?true:false;
        draw(gdisplay_array,null,null,whole);
    })


    function draw(display_array,TempData,EMCData,whole){
        var display_par;
        gdisplay_array = display_array;

        if((TempData != null) && (EMCData != null)){
            gTempData = TempData;
            gEMCData = EMCData;
        }
        if(whole == true)
            display_par = 1;
        else
            display_par = 0.85;
        gdisplay_par = display_par;
        $('.draw').addClass('charts-half');
        for(var i = 0;i<display_array.length;i++){
            $('#chart'+(display_array[i]+1).toString()).removeClass('charts-hidden');
        }
        console.log("doc get chart width => "+document.getElementById('chart2').offsetWidth);
        /*
        * function draw line graph
        */
        var newData = [];
        var formatDate = d3.time.format("%c");
        var maxSec = new Date(gTempData[0]['timestamp']);
        var minSec = new Date(gTempData[gTempData.length-1]['timestamp']);
        var buckets = d3.time.seconds(minSec,maxSec,20); 
        /*
        * get JsonData from
        */
        var timestamp_array = [];
        var newTime = gTempData[0]['timestamp'];
        for(var i=0;i<gTempData.length;i++){
            if(gTempData[i+1]!=null){
                if(newTime-gTempData[i]['timestamp']<1000*60){
                    var newObj1 = {};
                    newObj1['timestamp'] = gTempData[i].timestamp;
                    newObj1['Temp'] = gTempData[i]['Temp']>100?0:gTempData[i]['Temp'];
                    newObj1['EMC'] = gEMCData[i]['EMC'];
                    newObj1['sensorId'] = gTempData[i]['sensorId'];
                    timestamp_array.push(newObj1);
                    newTime = gTempData[i]['timestamp'];
                }
                else{
                    for(var j=0;j<24;j++){
                        var newObj = {};
                        newObj['timestamp'] = newTime-1000*20;
                        newObj['Temp'] = null;
                        newObj['EMC'] = null;
                        newObj['sensorId'] = j+1;
                        timestamp_array.push(newObj);
                        newTime -= 1000*20; 
                    }
                }
            }
        };
        console.log(timestamp_array);
        // for(var i=0;i<gTempData.length;i++){
        //     gTempData[i]['timestamp'] = gTempData[i].timestamp;
        //     gTempData[i]['Temp'] = +gTempData[i]['Temp'];
        //     gTempData[i]['Hum'] = +gEMCData[i]['Hum'];
        //     gTempData[i]['sensorId'] = +gTempData[i]['sensorId'];
        // };
        TempData = timestamp_array;

        var window_width = $(window).width();
        var width = window_width>1101?(window_width*display_par*0.5-22):(window_width*display_par-22);
        console.log("chart width is => "+width);
        d3.selectAll('svg').remove();
        for(var i=0;i<display_array.length;i++){
            CreatePlots(width,timestamp_array,display_array[i],display_array,gRanges);
        }
        // var slider_width = window_width*display_par - 15;
        // TimeLine(slider_width,gTempData,display_array,width,gRanges);
    }
    /*******************************************************************************/
    function findHum(this_time,this_id){
        for(var i=0;i<gEMCData.length;){
            if(gEMCData[i].timestamp == this_time){
                if(gEMCData[i]['sensorId'] == this_id)
                    return gEMCData[i]['EMC'];
            }
            else
                i++;
        }

        return 0;
    }
</script>
<script>
    var header = $('.header');
    var collopse = $('#collopse-button');
    var sidebar = $('.sidebar');
    var main = $('.main-visual');
    var offset = header.offset().top;
    /****************sticky header*************************/
    $(window).scroll(function(){
        if($(window).scrollTop() > offset)
            header.addClass('sticky-header');
        else
            header.removeClass('sticky-header');
    });
    /********************************************************/
    /********************** collopse span *******************/
    collopse.click(function(){
        if($('.sidebar').css('display') == 'none'){
            main.removeClass('whole');

            setTimeout(function(){
                $('.sidebar').removeClass('inactive');
                setTimeout(draw(gdisplay_array,null,null,false),3000);
            })

        }
        else{
            $('.sidebar').addClass('inactive');
            main.addClass('whole');
            setTimeout(draw(gdisplay_array,null,null,true),1000);
        }
    });
    /*--------------------------------------------------------------------------------*/
    /*
    * Add input range
    */
    var add_range = $('#add-range');
    var form4 = $('.form-container');
    add_range.click(function(){
        form4.css('display','block');
    })
    var rerange = $('#submit-button4').click(function(){
        var TempMax = parseFloat($('input[name=TMax]').val());
        var TempMin = parseFloat($('input[name=TMin]').val());
        var HumMax = parseFloat($('input[name=HMax]').val());
        var HumMin = parseFloat($('input[name=HMin]').val());
        var this_ranges = {
            "TempMax":TempMax,
            "TempMin":TempMin,
            "HumMax":HumMax,
            "HumMin":HumMin,
            "TimeMax":null,
            "TimeMin":null
        }
        console.log(this_ranges);
        var window_width = $(window).width();
        var this_width = window_width>1101?(window_width*gdisplay_par*0.5-22):(window_width*gdisplay_par-22);

        d3.selectAll('svg').remove();
        gRanges = this_ranges;
        var whole = gdisplay_par>0.9?true:false;
        draw(gdisplay_array,null,null,whole);
        
        form4.css('display','none');
        add_range.removeClass('sidebar-active');
        gdisplay_class.addClass('sidebar-active');
    })
</script>
<script>
    var rightSelector = $('#select-right');
    var leftSelector = $('#select-left');
    var middleSelector = $('#select-middle');
    var fanSelector = $('#select-fan');
    var dryerSelector = $('#select-dryer');

    rightSelector.click(function(){
        var new_display = arrayIntersect(gdisplay_side,gRIGHT);
        console.log(new_display);
        if(new_display.length > 0) {
            d3.selectAll('svg').remove();
            $('.charts').addClass('charts-hidden');

            draw(new_display, null, null, false);
        }
    });

    leftSelector.click(function(){
        var new_display = arrayIntersect(gdisplay_side,gLEFT);
        if(new_display.length > 0) {
            d3.selectAll('svg').remove();
            $('.charts').addClass('charts-hidden');

            draw(new_display, null, null, false);
        }
    });

    middleSelector.click(function(){
        var new_display = arrayIntersect(gdisplay_side,gMIDDLE);
        if(new_display.length > 0) {
            d3.selectAll('svg').remove();
            $('.charts').addClass('charts-hidden');

            draw(new_display, null, null, false);
        }
    });

    fanSelector.click(function(){
        d3.selectAll('svg').remove();
        $('.charts').addClass('charts-hidden');
        var new_display = arrayIntersect(gdisplay_side,gFAN);
        draw(new_display,null,null,false);
    });

    dryerSelector.click(function(){
        var new_display = arrayIntersect(gdisplay_side,gDRYER);
        if(new_display.length > 0) {
            d3.selectAll('svg').remove();
            $('.charts').addClass('charts-hidden');
            draw(new_display, null, null, false);
        }
    });
</script>
<script>
$('#disF_left').click(function(){
    console.log('click');
    var this_display = arrayIntersect(gLEFT,gFAN);
    gchoiceF = this_display;
    this_display = gchoiceD.concat(this_display);
    console.log(this_display);
    d3.selectAll('svg').remove();
    $('.charts').addClass('charts-hidden');
    var whole = gdisplay_par>0.9?true:false;
    draw(this_display,null,null,whole);
})
$('#disF_middle').click(function(){
    console.log('click');
    var this_display = arrayIntersect(gMIDDLE,gFAN);
    gchoiceF = this_display;
    this_display = gchoiceD.concat(this_display);
    console.log(this_display);
    d3.selectAll('svg').remove();
    $('.charts').addClass('charts-hidden');
    var whole = gdisplay_par>0.9?true:false;
    draw(this_display,null,null,whole);
})
$('#disF_right').click(function(){
    console.log('click');
    var this_display = arrayIntersect(gRIGHT,gFAN);
    gchoiceF = this_display;
    this_display = gchoiceD.concat(this_display);
    console.log(this_display);
    d3.selectAll('svg').remove();
    $('.charts').addClass('charts-hidden');
    var whole = gdisplay_par>0.9?true:false;
    draw(this_display,null,null,whole);
})
$('#disD_left').click(function(){
    console.log('click');
    var this_display = arrayIntersect(gLEFT,gDRYER);
    gchoiceD = this_display;
    this_display = gchoiceF.concat(this_display);
    console.log(this_display);
    d3.selectAll('svg').remove();
    $('.charts').addClass('charts-hidden');
    var whole = gdisplay_par>0.9?true:false;
    draw(this_display,null,null,whole);
})
$('#disD_middle').click(function(){
    console.log('click');
    var this_display = arrayIntersect(gMIDDLE,gDRYER);
    gchoiceD = this_display;
    this_display = gchoiceF.concat(this_display);
    console.log(this_display);
    d3.selectAll('svg').remove();
    $('.charts').addClass('charts-hidden');
    var whole = gdisplay_par>0.9?true:false;
    draw(this_display,null,null,whole);
})
$('#disD_right').click(function(){
    console.log('click');
    var this_display = arrayIntersect(gRIGHT,gDRYER);
    gchoiceD = this_display;
    this_display = gchoiceF.concat(this_display);
    console.log(this_display);
    d3.selectAll('svg').remove();
    $('.charts').addClass('charts-hidden');
    var whole = gdisplay_par>0.9?true:false;
    draw(this_display,null,null,whole);
})
</script>
<script>
    /*
    * click on sidebar column
    */
    var sidebar = $('.sidebar-column');

    sidebar.click(function(){
        $(this).addClass('sidebar-active');
        $(this).siblings().removeClass('sidebar-active');
    });
</script>

</html>